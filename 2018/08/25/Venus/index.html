<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="最不稀罕的东西：不在乎人的赞美，不喜欢人的殷勤，还有你无差别对待的好"><title>Venus | Tango</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Venus</h1><a id="logo" href="/.">Tango</a><p class="description">探戈</p></div><div id="nav-menu"><a href="/"><i class="fa fa-home"> 主页</i></a><a href="/archives/"><i class="fa fa-book"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Venus</h1><div class="post-meta">Aug 25, 2018<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#轻量级爬虫框架Venus"><span class="toc-text"><a href="#&#x8F7B;&#x91CF;&#x7EA7;&#x722C;&#x866B;&#x6846;&#x67B6;Venus" class="headerlink" title="&#x8F7B;&#x91CF;&#x7EA7;&#x722C;&#x866B;&#x6846;&#x67B6;Venus"></a>&#x8F7B;&#x91CF;&#x7EA7;&#x722C;&#x866B;&#x6846;&#x67B6;Venus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#核心组件"><span class="toc-text"><a href="#&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;" class="headerlink" title="&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;"></a>&#x6838;&#x5FC3;&#x7EC4;&#x4EF6;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#具体介绍"><span class="toc-text"><a href="#&#x5177;&#x4F53;&#x4ECB;&#x7ECD;" class="headerlink" title="&#x5177;&#x4F53;&#x4ECB;&#x7ECD;"></a>&#x5177;&#x4F53;&#x4ECB;&#x7ECD;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Downloader"><span class="toc-text"><a href="#Downloader" class="headerlink" title="Downloader"></a><strong>Downloader</strong></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scheduler"><span class="toc-text"><a href="#Scheduler" class="headerlink" title="Scheduler"></a><strong>Scheduler</strong></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spider"><span class="toc-text"><a href="#Spider" class="headerlink" title="Spider"></a><strong>Spider</strong></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Engine"><span class="toc-text"><a href="#Engine" class="headerlink" title="Engine"></a><strong>Engine</strong></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Parser"><span class="toc-text"><a href="#Parser" class="headerlink" title="Parser"></a><strong>Parser</strong></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline"><span class="toc-text"><a href="#Pipeline" class="headerlink" title="Pipeline"></a><strong>Pipeline</strong></span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h2 id="轻量级爬虫框架Venus"><a href="#轻量级爬虫框架Venus" class="headerlink" title="轻量级爬虫框架Venus"></a>轻量级爬虫框架Venus</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><ul>
<li><strong>Downloader</strong>(网页下载器)</li>
<li><strong>Spider</strong>(爬虫处理器)</li>
<li><strong>Scheduler</strong>(调度器)</li>
<li><strong>Parser</strong>(网页解析器)</li>
<li><strong>Pipline</strong>(数据处理器)</li>
<li><strong>Engine</strong>(流转引擎)</li>
</ul>
<h3 id="具体介绍"><a href="#具体介绍" class="headerlink" title="具体介绍"></a>具体介绍</h3><h4 id="Downloader"><a href="#Downloader" class="headerlink" title="Downloader"></a><strong>Downloader</strong></h4><p>网页下载器，顾名思义，就是从网络上下载数据，也就是爬虫的根本事件。给定一个或一组url,进行http请求，获取我们想要的数据（json、html、xml等）。而编写http请求的过程往往是重复的，所以应当进行封装以通用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Downloader</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler Scheduler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Request request;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Downloader</span><span class="params">(Scheduler scheduler, Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.Scheduler = scheduler;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start request url &#123;&#125;"</span>, request.getUrl());</span><br><span class="line">        HttpRequest httpRequest = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"get"</span>.equalsIgnoreCase(request.getMethod())) &#123;</span><br><span class="line">            httpRequest = HttpRequest.get(request.getUrl());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"post"</span>.equalsIgnoreCase(request.getMethod())) &#123;</span><br><span class="line">            httpRequest = HttpRequest.post(request.getUrl());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">"method &#123;&#125; 无效"</span>, request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InputStream inputStream = httpRequest.contentType(request.contentType())</span><br><span class="line">            .headers(request.headers()).connectTimeout(request.getSpider().getConfig().timeout())</span><br><span class="line">            .readTimeout(request.getSpider().getConfig().timeout()).stream();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"download has finsihed url &#123;&#125;"</span>, request.getUrl());</span><br><span class="line">        Response response = <span class="keyword">new</span> Response(request, inputStream);</span><br><span class="line">        Scheduler.addResponse(response);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个Downloader就是一个线程,<code>Request</code>对象封装了请求的信息，包括url、header等，请求完后，获取一个包含了返回数据的流，这里不作处理，直接构造一个<code>response</code>对象，然后压入到<code>Scheduler</code>（调取器）的返回队列中去。交给后续的爬虫处理器以及解析器来处理。</p>
<h4 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a><strong>Scheduler</strong></h4><p>调取器，就是调度请求与返回的，在解析器与下载器之间进行流转，解析器解析新的url加入请求队列中，调度器再生成新的下载器进行下载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BlockingQueue&lt;Request&gt; pending = Queues.newLinkedBlockingQueue();</span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;Response&gt; processed = Queues.newLinkedBlockingQueue();</span><br></pre></td></tr></table></figure>
<p>Scheduler中有两个队列，待爬取的Request和已爬取的Response。Scheduler提供入队和出队操作，供其他组件进行调用。</p>
<h4 id="Spider"><a href="#Spider" class="headerlink" title="Spider"></a><strong>Spider</strong></h4><p>爬虫处理器，用于对爬取的数据进行处理，比如说入库、写文件等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Spider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Config config;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> List&lt;String&gt; startUrls = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">protected</span> List&lt;Request&gt; requests = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">protected</span> List&lt;Pipeline&gt; pipelines = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfig</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Config <span class="title">getConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Pipeline&gt; <span class="title">getPipelines</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.pipelines;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPipelines</span><span class="params">(List&lt;Pipeline&gt; pipelines)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pipelines = pipelines;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Spider</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Spider</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        EventManager.registerEvent(EventManager.VenusEvent.SPIDER_STARTED, <span class="keyword">this</span>::onStart);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getStartUrls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.startUrls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Spider <span class="title">startUrls</span><span class="params">(String... urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startUrls.addAll(Arrays.asList(urls));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Request&gt; <span class="title">getRequests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.requests;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 爬虫启动前执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Config config)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">Spider <span class="title">addPipline</span><span class="params">(Pipeline&lt;T&gt; pipeline)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pipelines.add(pipeline);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建一个request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">makeRequest</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> makeRequest(url, <span class="keyword">this</span>::parse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Request&lt;T&gt; <span class="title">makeRequest</span><span class="params">(String url, Parser&lt;T&gt; parser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Request&lt;&gt;(<span class="keyword">this</span>, url, parser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析DOM</span></span><br><span class="line"><span class="comment">     * 子类需要实现此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">parse</span><span class="params">(Response response)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetRequest</span><span class="params">(Consumer&lt;Request&gt; consumer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resetRequest(<span class="keyword">this</span>.requests, consumer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetRequest</span><span class="params">(List&lt;Request&gt; requests, Consumer&lt;Request&gt; consumer)</span> </span>&#123;</span><br><span class="line">        requests.forEach(consumer::accept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>param-startUrls  抽象类<code>Spider</code>维护了一个url集合，用于接受爬虫原始的url，进一步封装成request对象</li>
<li>method-parse 抽象方法，子类实现该方法定义自己的解析操作</li>
<li>param-pipeline 管道集合，进行数据处理的类，类似管道</li>
</ul>
<h4 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a><strong>Engine</strong></h4><p>整个爬虫流程的核心控制器，流转引擎</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VenusEngine</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Spider&gt; spiders;</span><br><span class="line">    <span class="keyword">private</span> Config config;</span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VenusEngine</span><span class="params">(Venus venus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.spiders = venus.spiders;</span><br><span class="line">        <span class="keyword">this</span>.config = venus.config;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = <span class="keyword">new</span> Scheduler();</span><br><span class="line">        <span class="keyword">this</span>.executorService = <span class="keyword">new</span> ThreadPoolExecutor(config.parallelThreads(), config.parallelThreads(), </span><br><span class="line">            <span class="number">60L</span>, TimeUnit.MILLISECONDS, config.queueSize() == <span class="number">0</span> ? <span class="keyword">new</span> SynchronousQueue&lt;&gt;()</span><br><span class="line">            : (config.queueSize() &lt; <span class="number">0</span> ? <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;() : <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(config.queueSize())),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">"task-thread-%d"</span>).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Venus 已经启动"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        isRunning = <span class="keyword">true</span>;</span><br><span class="line">        log.info(<span class="string">"全局启动事件"</span>);</span><br><span class="line">        EventManager.fireEvent(VenusEvent.GLOBAL_STARTED, <span class="keyword">this</span>.config);</span><br><span class="line"></span><br><span class="line">        spiders.forEach(spider -&gt; &#123;</span><br><span class="line">            <span class="comment">// 使用克隆为每个spider对象设置一个config属性</span></span><br><span class="line">            Config config = <span class="keyword">this</span>.config.clone();</span><br><span class="line">            spider.setConfig(config);</span><br><span class="line">            </span><br><span class="line">            List&lt;Request&gt; requests = spider.getStartUrls().stream()</span><br><span class="line">                .map(spider::makeRequest).collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            spider.getRequests().addAll(requests);</span><br><span class="line">            scheduler.addRequest(requests);</span><br><span class="line">            EventManager.fireEvent(VenusEvent.SPIDER_STARTED, <span class="keyword">this</span>.config);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启一个线程来不断扫描是否有带爬取的Request</span></span><br><span class="line">        Thread downloadThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!scheduler.hasRequest()) &#123;</span><br><span class="line">                    VenusUtils.sleep(<span class="number">100</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Request request = scheduler.nextRequest();</span><br><span class="line">                executorService.submit(<span class="keyword">new</span> Downloader(scheduler, request));</span><br><span class="line">                VenusUtils.sleep(request.getSpider().getConfig().Delay());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        downloadThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        downloadThread.setName(<span class="string">"download-thread"</span>);</span><br><span class="line">        downloadThread.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//消费</span></span><br><span class="line">        <span class="keyword">this</span>.complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!scheduler.hasResponse()) &#123;</span><br><span class="line">                VenusUtils.sleep(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Response response = scheduler.nextResponse();</span><br><span class="line">            Parser parser   = response.getRequest().getParser();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != parser) &#123;</span><br><span class="line">                Result&lt;?&gt;     result   = parser.parse(response);</span><br><span class="line">                List&lt;Request&gt; requests = result.getRequests();</span><br><span class="line">                <span class="keyword">if</span> (!VenusUtils.isEmpty(requests)) &#123;</span><br><span class="line">                    requests.forEach(scheduler::addRequest);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != result.getItem()) &#123;</span><br><span class="line">                    List&lt;Pipeline&gt; pipelines = response.getRequest().getSpider().getPipelines();</span><br><span class="line">                    pipelines.forEach(pipeline -&gt; pipeline.process(result.getItem(), response.getRequest()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流转引擎主要分为以下几个步骤：</p>
<ol>
<li>遍历spider集合，构建request，压入调度器，同时消费爬虫启动事件。</li>
<li>开启一个线程来专门从调取器中获取待处理的request，创建相应的下载器去下载。</li>
<li>消费response,这里分为两步parser和pipeline，解析和处理。</li>
</ol>
<h4 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a><strong>Parser</strong></h4><p>网页解析器，对元数据进行解析，提取我们所需的信息，转换成对应的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Parser</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Result&lt;T&gt; <span class="title">parse</span><span class="params">(Response response)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现该方法编写自己的解析逻辑</p>
<h4 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a><strong>Pipeline</strong></h4><p>数据处理器，pipeline有管道的意思，解析器完成解析后，把解析的结果扔进数据处理管道中进行处理。是入库，写文件还是打印等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pipeline</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(T item, Request&lt;?&gt; Request)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/spider、framework/">spider、framework</a></div><div class="post-nav"><a class="pre" href="/2018/09/21/post请求流的使用/">post请求流的使用</a><a class="next" href="/2017/12/29/LogAspect/">使用AOP实现日志切入</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="www.google.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/AOP/" style="font-size: 15px;">AOP</a> <a href="/tags/spider、framework/" style="font-size: 15px;">spider、framework</a> <a href="/tags/echo-server/" style="font-size: 15px;">echo server</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/21/post请求流的使用/">post请求流的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/25/Venus/">Venus</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/29/LogAspect/">使用AOP实现日志切入</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/19/echo-server/">使用java NIO实现一个echo server</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="github" target="_blank">github</a><ul></ul><a href="http://www.example2.com/" title="知乎" target="_blank">知乎</a><ul></ul><a href="https://www.jianshu.com/u/a7938ba99b25" title="简书" target="_blank">简书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Tango.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>